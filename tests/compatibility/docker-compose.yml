# Side-by-side comparison test environment for Mountebank and Rift
#
# Usage:
#   docker compose up -d
#   ./run-tests.sh
#   docker compose down

services:
  # Original Mountebank
  mountebank:
    image: bbyars/mountebank:2.9.2
    container_name: mb-original
    ports:
      - "2525:2525" # Admin API
      - "4545:4545" # Test imposter port 1
      - "4546:4546" # Test imposter port 2
      - "4547:4547" # Test imposter port 3
    command: ["start", "--allowInjection", "--loglevel", "info"]
    healthcheck:
      # Use wget since curl is not available in the mountebank image
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:2525/"]
      interval: 5s
      timeout: 10s
      retries: 15
      start_period: 10s

  # Rift (Mountebank-compatible mode)
  rift:
    build:
      context: ../..
      dockerfile: crates/rift-http-proxy/Dockerfile
    container_name: rift-proxy
    ports:
      - "3525:2525" # Admin API (mapped to different host port)
      - "5545:4545" # Test imposter port 1
      - "5546:4546" # Test imposter port 2
      - "5547:4547" # Test imposter port 3
      - "9090:9090" # Metrics
    environment:
      - MB_PORT=2525
      - MB_ALLOW_INJECTION=true
      - RUST_LOG=debug
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:2525/"]
      interval: 5s
      timeout: 10s
      retries: 15
      start_period: 5s

networks:
  default:
    name: rift-compat-test
