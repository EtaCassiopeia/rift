#!/bin/bash
# Pre-push hook to run formatting, lint, and all test checks
# This prevents pushing code with formatting, lint issues, or failing tests
#
# Environment variables:
#   SKIP_TESTS=1              - Skip unit tests (not recommended)
#   SKIP_COMPATIBILITY=1      - Skip Mountebank compatibility tests
#   QUICK_PUSH=1              - Only run format, clippy, and unit tests (skip Docker tests)

set -e

echo "üîç Running pre-push checks..."

# Check formatting
echo "üìù Checking code formatting..."
if ! cargo fmt --all -- --check; then
    echo ""
    echo "‚ùå Code formatting check failed!"
    echo "üí° Run: cargo fmt --all"
    echo ""
    exit 1
fi
echo "‚úÖ Formatting check passed"

# Run clippy
echo "üîß Running clippy lint checks..."
if ! cargo clippy --workspace --all-targets --all-features -- -D warnings; then
    echo ""
    echo "‚ùå Clippy lint check failed!"
    echo "üí° Run: cargo clippy --workspace --all-targets --all-features -- -D warnings"
    echo "üí° Or auto-fix: cargo clippy --fix --workspace --all-targets --all-features --allow-dirty"
    echo ""
    exit 1
fi
echo "‚úÖ Clippy check passed"

# Run unit tests (unless SKIP_TESTS=1)
if [ "${SKIP_TESTS:-0}" != "1" ]; then
    echo "üß™ Running unit tests..."
    if ! cargo test --workspace --all-features --lib; then
        echo ""
        echo "‚ùå Unit tests failed!"
        echo "üí° Run: cargo test --workspace --all-features --lib"
        echo "üí° To skip tests (not recommended): SKIP_TESTS=1 git push"
        echo ""
        exit 1
    fi
    echo "‚úÖ Unit tests passed"
else
    echo "‚ö†Ô∏è  Skipping unit tests (SKIP_TESTS=1)"
fi

# Check if Docker tests should be skipped
SKIP_DOCKER="${QUICK_PUSH:-0}"

# Run compatibility tests (unless skipped)
if [ "$SKIP_DOCKER" != "1" ] && [ "${SKIP_COMPATIBILITY:-0}" != "1" ]; then
    echo "üîÑ Running Mountebank compatibility tests..."
    echo "   This will start Docker containers and run 72 BDD tests"
    echo ""

    # Check if docker compose is available
    if ! command -v docker &> /dev/null; then
        echo "‚ùå Docker is not installed or not in PATH"
        exit 1
    fi

    COMPAT_DIR="$(git rev-parse --show-toplevel)/tests/compatibility"

    # Start the test environment
    echo "   Starting test environment..."
    (cd "$COMPAT_DIR" && docker compose up -d --build --wait)

    # Wait for services to be healthy
    echo "   Waiting for services to be healthy..."
    for i in {1..30}; do
        mb_health=$(docker inspect --format='{{.State.Health.Status}}' mb-original 2>/dev/null || echo "not ready")
        rift_health=$(docker inspect --format='{{.State.Health.Status}}' rift-proxy 2>/dev/null || echo "not ready")
        if [ "$mb_health" = "healthy" ] && [ "$rift_health" = "healthy" ]; then
            echo "   Both services are healthy!"
            break
        fi
        sleep 2
    done

    # Run the tests
    if ! (cd "$COMPAT_DIR" && cargo test --release); then
        echo ""
        echo "‚ùå Compatibility tests failed!"
        echo "üí° Run manually: cd tests/compatibility && docker compose up -d && cargo test"
        echo "üí° To skip: SKIP_COMPATIBILITY=1 git push"
        echo ""
        # Clean up
        (cd "$COMPAT_DIR" && docker compose down -v) || true
        exit 1
    fi

    # Clean up
    (cd "$COMPAT_DIR" && docker compose down -v) || true
    echo "‚úÖ Compatibility tests passed (72 tests)"
else
    if [ "$SKIP_DOCKER" = "1" ]; then
        echo "‚ÑπÔ∏è  Skipping compatibility tests (QUICK_PUSH=1)"
    else
        echo "‚ÑπÔ∏è  Skipping compatibility tests (SKIP_COMPATIBILITY=1)"
    fi
fi

echo ""
echo "‚úÖ All pre-push checks passed! Proceeding with push..."
echo ""
