# GitHub Actions workflow to update Homebrew formula
# Copy this file to: .github/workflows/update-homebrew.yml in this repo
#
# Prerequisites:
# 1. Create repository: github.com/EtaCassiopeia/homebrew-rift
# 2. Add HOMEBREW_TAP_TOKEN secret (personal access token with repo scope)
#    Or use the default GITHUB_TOKEN if the tap repo is in the same org

name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.1.0)'
        required: true
        type: string

env:
  TAP_REPO: EtaCassiopeia/homebrew-rift
  FORMULA_NAME: rift

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUM=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Download release assets and calculate checksums
        id: checksums
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BASE_URL="https://github.com/EtaCassiopeia/rift/releases/download/${VERSION}"

          # Download and calculate SHA256 for each platform
          echo "Downloading macOS ARM64..."
          curl -sL "${BASE_URL}/rift-${VERSION}-aarch64-apple-darwin.tar.gz" -o macos-arm64.tar.gz
          SHA_MACOS_ARM64=$(sha256sum macos-arm64.tar.gz | cut -d' ' -f1)
          echo "SHA_MACOS_ARM64=$SHA_MACOS_ARM64" >> $GITHUB_OUTPUT

          echo "Downloading macOS x86_64..."
          curl -sL "${BASE_URL}/rift-${VERSION}-x86_64-apple-darwin.tar.gz" -o macos-x86_64.tar.gz
          SHA_MACOS_X86_64=$(sha256sum macos-x86_64.tar.gz | cut -d' ' -f1)
          echo "SHA_MACOS_X86_64=$SHA_MACOS_X86_64" >> $GITHUB_OUTPUT

          echo "Downloading Linux ARM64..."
          curl -sL "${BASE_URL}/rift-${VERSION}-aarch64-unknown-linux-gnu.tar.gz" -o linux-arm64.tar.gz
          SHA_LINUX_ARM64=$(sha256sum linux-arm64.tar.gz | cut -d' ' -f1)
          echo "SHA_LINUX_ARM64=$SHA_LINUX_ARM64" >> $GITHUB_OUTPUT

          echo "Downloading Linux x86_64..."
          curl -sL "${BASE_URL}/rift-${VERSION}-x86_64-unknown-linux-gnu.tar.gz" -o linux-x86_64.tar.gz
          SHA_LINUX_X86_64=$(sha256sum linux-x86_64.tar.gz | cut -d' ' -f1)
          echo "SHA_LINUX_X86_64=$SHA_LINUX_X86_64" >> $GITHUB_OUTPUT

          echo "Checksums calculated:"
          echo "  macOS ARM64:  $SHA_MACOS_ARM64"
          echo "  macOS x86_64: $SHA_MACOS_X86_64"
          echo "  Linux ARM64:  $SHA_LINUX_ARM64"
          echo "  Linux x86_64: $SHA_LINUX_X86_64"

      - name: Checkout homebrew tap
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPO }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap

          VERSION="${{ steps.version.outputs.VERSION_NUM }}"

          cat > Formula/${{ env.FORMULA_NAME }}.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          # Homebrew formula for Rift
          # Auto-generated by GitHub Actions - do not edit manually

          class Rift < Formula
            desc "High-performance, Mountebank-compatible HTTP chaos engineering proxy"
            homepage "https://github.com/EtaCassiopeia/rift"
            license "Apache-2.0"
            version "${{ steps.version.outputs.VERSION_NUM }}"

            on_macos do
              on_arm do
                url "https://github.com/EtaCassiopeia/rift/releases/download/${{ steps.version.outputs.VERSION }}/rift-${{ steps.version.outputs.VERSION }}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.SHA_MACOS_ARM64 }}"
              end
              on_intel do
                url "https://github.com/EtaCassiopeia/rift/releases/download/${{ steps.version.outputs.VERSION }}/rift-${{ steps.version.outputs.VERSION }}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.SHA_MACOS_X86_64 }}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/EtaCassiopeia/rift/releases/download/${{ steps.version.outputs.VERSION }}/rift-${{ steps.version.outputs.VERSION }}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.SHA_LINUX_ARM64 }}"
              end
              on_intel do
                url "https://github.com/EtaCassiopeia/rift/releases/download/${{ steps.version.outputs.VERSION }}/rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${{ steps.checksums.outputs.SHA_LINUX_X86_64 }}"
              end
            end

            def install
              bin.install "bin/rift"
              bin.install "bin/rift-lint"
              bin.install "bin/rift-tui"
            end

            def caveats
              <<~EOS
                Rift has been installed with the following binaries:
                  - rift: Main HTTP proxy server (Mountebank-compatible)
                  - rift-lint: Imposter configuration validator
                  - rift-tui: Terminal UI for managing imposters

                To start the server:
                  rift --port 2525

                For more information, visit:
                  https://github.com/EtaCassiopeia/rift
              EOS
            end

            test do
              assert_match "rift", shell_output("#{bin}/rift --version")
              assert_match "rift-lint", shell_output("#{bin}/rift-lint --version")
            end
          end
          FORMULA_EOF

      - name: Commit and push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/${{ env.FORMULA_NAME }}.rb
          git commit -m "Update ${{ env.FORMULA_NAME }} to ${{ steps.version.outputs.VERSION }}"
          git push
