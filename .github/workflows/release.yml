name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v0.1.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  BINARY_NAME: rift

jobs:
  # =============================================================================
  # Build binaries for all platforms
  # =============================================================================
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (glibc)
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
            archive: tar.gz
            features: lua,javascript,redis-backend

          # Linux ARM64 (glibc)
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            archive: tar.gz
            features: javascript,redis-backend
            cross: true

          # Linux x86_64 (musl - static binary)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-22.04
            archive: tar.gz
            features: javascript,redis-backend
            cross: true

          # Linux ARM64 (musl - static binary)
          - target: aarch64-unknown-linux-musl
            os: ubuntu-22.04
            archive: tar.gz
            features: javascript,redis-backend
            cross: true

          # macOS x86_64 (Intel)
          - target: x86_64-apple-darwin
            os: macos-13
            archive: tar.gz
            features: lua,javascript,redis-backend

          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-14
            archive: tar.gz
            features: lua,javascript,redis-backend

          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
            features: javascript,redis-backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # Select Xcode 15.x to avoid ring 0.17.14 compilation issues with Xcode 16.x
      - name: Select Xcode (macOS 13)
        if: matrix.os == 'macos-13'
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      - name: Select Xcode (macOS 14)
        if: matrix.os == 'macos-14'
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (non-musl)
        if: matrix.cross && !contains(matrix.target, 'musl')
        uses: taiki-e/setup-cross-toolchain-action@v1
        with:
          target: ${{ matrix.target }}

      - name: Install cross (for musl targets)
        if: matrix.cross && contains(matrix.target, 'musl')
        uses: taiki-e/install-action@cross

      # Install LuaJIT on native Linux/macOS builds
      - name: Install LuaJIT (Ubuntu)
        if: matrix.os == 'ubuntu-22.04' && !matrix.cross
        run: sudo apt-get update && sudo apt-get install -y libluajit-5.1-dev

      - name: Install LuaJIT (macOS)
        if: startsWith(matrix.os, 'macos')
        run: brew install luajit pkg-config

      # Cache
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      # Build
      - name: Build release binary
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            # Use cross for musl targets (provides proper toolchain in Docker)
            cross build --release --package rift-http-proxy --target ${{ matrix.target }} --features ${{ matrix.features }}
          else
            cargo build --release --package rift-http-proxy --target ${{ matrix.target }} --features ${{ matrix.features }}
          fi

      # Package
      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release

          # Create archive directory
          ARCHIVE_NAME="${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION }}-${{ matrix.target }}"
          mkdir -p "$ARCHIVE_NAME"

          # Copy binary
          cp rift-http-proxy "$ARCHIVE_NAME/${{ env.BINARY_NAME }}"
          chmod +x "$ARCHIVE_NAME/${{ env.BINARY_NAME }}"

          # Create mb symlink for Mountebank compatibility
          cd "$ARCHIVE_NAME"
          ln -s ${{ env.BINARY_NAME }} mb
          cd ..

          # Copy docs
          cp ../../../README.md "$ARCHIVE_NAME/" 2>/dev/null || true
          cp ../../../LICENSE "$ARCHIVE_NAME/" 2>/dev/null || true
          cp ../../../CHANGELOG.md "$ARCHIVE_NAME/" 2>/dev/null || true

          # Create archive
          tar -czvf "$ARCHIVE_NAME.tar.gz" "$ARCHIVE_NAME"

          # Create checksum
          shasum -a 256 "$ARCHIVE_NAME.tar.gz" > "$ARCHIVE_NAME.tar.gz.sha256"

          echo "ASSET_PATH=target/${{ matrix.target }}/release/$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
          echo "ASSET_NAME=$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
          echo "CHECKSUM_PATH=target/${{ matrix.target }}/release/$ARCHIVE_NAME.tar.gz.sha256" >> $GITHUB_ENV
          echo "CHECKSUM_NAME=$ARCHIVE_NAME.tar.gz.sha256" >> $GITHUB_ENV

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd target/${{ matrix.target }}/release

          $ARCHIVE_NAME = "${{ env.BINARY_NAME }}-${{ steps.version.outputs.VERSION }}-${{ matrix.target }}"
          New-Item -ItemType Directory -Force -Path $ARCHIVE_NAME

          # Copy binary
          Copy-Item "rift-http-proxy.exe" "$ARCHIVE_NAME/${{ env.BINARY_NAME }}.exe"

          # Copy as mb.exe for Mountebank compatibility
          Copy-Item "rift-http-proxy.exe" "$ARCHIVE_NAME/mb.exe"

          # Copy docs
          if (Test-Path "../../../README.md") { Copy-Item "../../../README.md" "$ARCHIVE_NAME/" }
          if (Test-Path "../../../LICENSE") { Copy-Item "../../../LICENSE" "$ARCHIVE_NAME/" }
          if (Test-Path "../../../CHANGELOG.md") { Copy-Item "../../../CHANGELOG.md" "$ARCHIVE_NAME/" }

          # Create zip
          Compress-Archive -Path $ARCHIVE_NAME -DestinationPath "$ARCHIVE_NAME.zip"

          # Create checksum
          $hash = (Get-FileHash -Algorithm SHA256 "$ARCHIVE_NAME.zip").Hash.ToLower()
          "$hash  $ARCHIVE_NAME.zip" | Out-File -Encoding utf8 "$ARCHIVE_NAME.zip.sha256"

          echo "ASSET_PATH=target/${{ matrix.target }}/release/$ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
          echo "ASSET_NAME=$ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
          echo "CHECKSUM_PATH=target/${{ matrix.target }}/release/$ARCHIVE_NAME.zip.sha256" >> $env:GITHUB_ENV
          echo "CHECKSUM_NAME=$ARCHIVE_NAME.zip.sha256" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: |
            ${{ env.ASSET_PATH }}
            ${{ env.CHECKSUM_PATH }}
          retention-days: 1

  # =============================================================================
  # Publish to crates.io
  # =============================================================================
  # publish-crate:
  #   name: Publish to crates.io
  #   runs-on: ubuntu-22.04
  #   needs: build
  #   if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !inputs.dry_run)
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable

  #     - name: Install LuaJIT
  #       run: sudo apt-get update && sudo apt-get install -y libluajit-5.1-dev

  #     - name: Cache cargo registry
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.cargo/registry
  #         key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

  #     - name: Publish rift-http-proxy
  #       env:
  #         CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
  #       run: |
  #         cargo publish -p rift-http-proxy --allow-dirty || echo "Crate may already be published"

  # =============================================================================
  # Create GitHub Release
  # =============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | head -50

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cat << 'EOF' > release_notes.md
          ## Rift ${{ steps.version.outputs.VERSION }}

          Rift is a high-performance, Mountebank-compatible HTTP chaos engineering proxy.

          ### Installation

          #### Quick Install (Unix)
          ```bash
          # Download and extract (replace TARGET with your platform)
          curl -LO https://github.com/EtaCassiopeia/rift/releases/download/${{ steps.version.outputs.VERSION }}/rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz
          sudo mv rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu/rift /usr/local/bin/
          ```

          #### Using Docker
          ```bash
          docker pull etacassiopeia/rift-proxy:${{ steps.version.outputs.VERSION }}
          docker run -p 2525:2525 -p 9090:9090 etacassiopeia/rift-proxy:${{ steps.version.outputs.VERSION }}
          ```

          #### Using Cargo
          ```bash
          cargo install rift-http-proxy
          ```

          ### Available Binaries

          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | Linux (glibc) | x86_64 | `rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz` |
          | Linux (glibc) | ARM64 | `rift-${{ steps.version.outputs.VERSION }}-aarch64-unknown-linux-gnu.tar.gz` |
          | Linux (musl/static) | x86_64 | `rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-musl.tar.gz` |
          | Linux (musl/static) | ARM64 | `rift-${{ steps.version.outputs.VERSION }}-aarch64-unknown-linux-musl.tar.gz` |
          | macOS | Intel (x86_64) | `rift-${{ steps.version.outputs.VERSION }}-x86_64-apple-darwin.tar.gz` |
          | macOS | Apple Silicon (ARM64) | `rift-${{ steps.version.outputs.VERSION }}-aarch64-apple-darwin.tar.gz` |
          | Windows | x86_64 | `rift-${{ steps.version.outputs.VERSION }}-x86_64-pc-windows-msvc.zip` |

          ### Features

          All binaries include:
          - **Rhai scripting** (built-in)
          - **JavaScript scripting** (Boa engine)
          - **Redis backend** for distributed state

          Native builds (Linux glibc x86_64, macOS, Windows) additionally include:
          - **Lua scripting** (LuaJIT)

          ### Verification

          Each binary has an accompanying `.sha256` checksum file. Verify downloads with:
          ```bash
          shasum -a 256 -c rift-${{ steps.version.outputs.VERSION }}-x86_64-unknown-linux-gnu.tar.gz.sha256
          ```

          ### Mountebank Compatibility

          Rift includes an `mb` symlink/executable for drop-in Mountebank compatibility:
          ```bash
          # Use rift directly
          rift --port 2525

          # Or use the mb alias
          mb --port 2525
          ```

          ### Documentation

          - [README](https://github.com/EtaCassiopeia/rift#readme)
          - [Mountebank Compatibility](https://github.com/EtaCassiopeia/rift/blob/main/docs/mountebank-compatibility.md)

          EOF

      - name: Create Release
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !inputs.dry_run)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Rift ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" | while read f; do
            echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY
          done

  # =============================================================================
  # Publish npm package
  # =============================================================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: release
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && !inputs.dry_run)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update package version
        working-directory: packages/rift-node
        run: |
          # Update version in package.json to match release tag
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Install dependencies
        working-directory: packages/rift-node
        env:
          RIFT_SKIP_BINARY_DOWNLOAD: '1'
        run: npm ci

      - name: Build
        working-directory: packages/rift-node
        run: npm run build

      - name: Run tests (unit only, no binary needed)
        working-directory: packages/rift-node
        run: npm run test:unit

      - name: Publish to npm
        working-directory: packages/rift-node
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public

      - name: npm Summary
        run: |
          echo "## npm Package Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** @rift-vs/rift" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install with:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install @rift-vs/rift" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
